---
title: "Market simulator"
output: 
  flexdashboard::flex_dashboard:
    orientation: row
    vertical_layout: scroll
runtime: shiny
---

```{r load-packages, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(flexdashboard)
library(plotly)
library(shiny)
```

```{r load-data, message=FALSE}

# If we simplify any of the default data sets make sure it matches the gammas as well.

# number of Gamma rows -> number of Organization rows

# number of Gamma Cols -> number of segment Rows


# Gammas of the "everything" model
gammas <- read_rds(
    here::here('data', 'public_political_social_charity_demo.rds')
  ) %>% 
  group_by(i, j) %>% 
  summarize(gamma_mean = mean(Gamma)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = j, values_from = gamma_mean) %>% 
  select(-i) %>% 
  t()

gammas <- gammas[,1:12]
  

# Default configurations
prod_default <- read_csv(
    here::here('data', 'org_data_default.csv')
  ) %>% 
  mutate(
    levels = c(
      # Brand
      "Hydroflask",
      "Conmigo",
      "Nalgene",
      "Camelbak",
      # Lid Type default = Screwcap
      "Wide Mouth", 
      "Squeeze",
      "Straw",
      # Size default = 24 oz
      "36 oz",
      # Material default = plastic
      "Metal",
      # Color Default = Clear 
      "Red", 
      "Blue",
      # Price Default = $19.99
      "$24.99",
      "$29.99"
    )
  ) %>% 
  rename(
    prod1_value = org1_value,
    prod2_value = org2_value,
    prod3_value = org3_value,
    prod4_value = org4_value 
  )

seg_default <- read_csv(
    here::here('data', 'per_data_default.csv')
  ) %>% 
  head(., 12) %>% 
  mutate(
    levels = c(
      # Intercept
      "Intercept",
      # Gender
      "Female",
      "Other",
      # Age
      "35-50",
      "51+",
      # Race 
      'White',
      'Black or African American',
      'American Indian or Alaskan Native',
      'Asian',
      'Native Hawaiian or Pacific Islander',
      'Hispanic or Latino',
      'Other race'
    )
  ) %>% 
  rename(
    seg1_value = per1_value,
    seg2_value = per2_value,
    seg3_value = per3_value
  )
```

```{r product-reactive-table}
# Assign level labels
prod_table <- data.frame(
  levels = c(
    # Brand
    "Hydroflask",
    "Conmigo",
    "Nalgene",
    "Camelbak",
    # Lid Type default = Screwcap
    "Wide Mouth", 
    "Squeeze",
    "Straw",
    # Size default = 24 oz
    "36 oz",
    # Material default = plastic
    "Metal",
    # Color Default = Clear 
    "Red", 
    "Blue",
    # Price Default = $19.99
    "$24.99",
    "$29.99"
  )
)

# Product configuration reactive element
prod_reactive <- reactive({
  # Product 1
  prod_table$prod1_value <- 0
  prod_table$prod1_value[prod_table$levels %in% input$prod1_prod] <- 1
  prod_table$prod1_value[prod_table$levels %in% input$prod1_lid] <- 1
  prod_table$prod1_value[prod_table$levels %in% input$prod1_size] <- 1
  prod_table$prod1_value[prod_table$levels %in% input$prod1_mat] <- 1
  prod_table$prod1_value[prod_table$levels %in% input$prod1_color] <- 1
  prod_table$prod1_value[prod_table$levels %in% input$prod1_price] <- 1
    
  # Product 2
  prod_table$prod2_value <- 0
  prod_table$prod2_value[prod_table$levels %in% input$prod2_prod] <- 1
  prod_table$prod2_value[prod_table$levels %in% input$prod2_lid] <- 1
  prod_table$prod2_value[prod_table$levels %in% input$prod2_size] <- 1
  prod_table$prod2_value[prod_table$levels %in% input$prod2_mat] <- 1
  prod_table$prod2_value[prod_table$levels %in% input$prod2_color] <- 1
  prod_table$prod2_value[prod_table$levels %in% input$prod2_price] <- 1
    
  # Product 3
  prod_table$prod3_value <- 0
  prod_table$prod3_value[prod_table$levels %in% input$prod3_prod] <- 1
  prod_table$prod3_value[prod_table$levels %in% input$prod3_lid] <- 1
  prod_table$prod3_value[prod_table$levels %in% input$prod3_size] <- 1
  prod_table$prod3_value[prod_table$levels %in% input$prod3_mat] <- 1
  prod_table$prod3_value[prod_table$levels %in% input$prod3_color] <- 1
  prod_table$prod3_value[prod_table$levels %in% input$prod3_price] <- 1
    
  # Product 4
  prod_table$prod4_value <- 0
  prod_table$prod4_value[prod_table$levels %in% input$prod4_prod] <- 1
  prod_table$prod4_value[prod_table$levels %in% input$prod4_lid] <- 1
  prod_table$prod4_value[prod_table$levels %in% input$prod4_size] <- 1
  prod_table$prod4_value[prod_table$levels %in% input$prod4_mat] <- 1
  prod_table$prod4_value[prod_table$levels %in% input$prod4_color] <- 1
  prod_table$prod4_value[prod_table$levels %in% input$prod4_price] <- 1
  prod_table
})
```

```{r segment-reactive-table}
# Assign covariate labels
seg_table <- data.frame(
  levels = c(
    # Intercept
    "Intercept",
    # Gender
    "Female",
    "Other",
    # Age
    "35-50",
    "51+",
    # Race 
    'White',
    'Black or African American',
    'American Indian or Alaskan Native',
    'Asian',
    'Native Hawaiian or Pacific Islander',
    'Hispanic or Latino',
    'Other race'
  )
)

# Segment configuration reactive element
seg_reactive <- reactive({
  # Segment 1
  seg_table$seg1_value <- 0
  seg_table$seg1_value[seg_table$levels == 'Intercept'] <- 1
  seg_table$seg1_value[seg_table$levels %in% input$seg1_gender] <- 1
  seg_table$seg1_value[seg_table$levels %in% input$seg1_age] <- 1
  seg_table$seg1_value[seg_table$levels %in% input$seg1_race] <- 1
    
  # Segment 2
  seg_table$seg2_value <- 0
  seg_table$seg2_value[seg_table$levels == 'Intercept'] <- 1
  seg_table$seg2_value[seg_table$levels %in% input$seg2_gender] <- 1
  seg_table$seg2_value[seg_table$levels %in% input$seg2_age] <- 1
  seg_table$seg2_value[seg_table$levels %in% input$seg2_race] <- 1
    
  # Segment 3
  seg_table$seg3_value <- 0
  seg_table$seg3_value[seg_table$levels == 'Intercept'] <- 1
  seg_table$seg3_value[seg_table$levels %in% input$seg3_gender] <- 1
  seg_table$seg3_value[seg_table$levels %in% input$seg3_age] <- 1
  seg_table$seg3_value[seg_table$levels %in% input$seg3_race] <- 1
  seg_table
})
```

Market share
====================================================

Plot
-------------------------------------------------

### Product Market Share Per Segment

```{r compute-and-plot}
# Compute and render the market share plot
renderPlotly({
  prod_choice = prod_reactive()
  seg_choice = seg_reactive()
    
  # Segment 1 predicted betas
  seg1_betas <- as.matrix(gammas) %*% as.matrix(seg_choice[,2])
  
  # Segment 1 expected utilities
  seg1_prod1_exp <- exp(t(prod_choice[,2]) %*% as.matrix(seg1_betas))
  seg1_prod2_exp <- exp(t(prod_choice[,3]) %*% as.matrix(seg1_betas))
  seg1_prod3_exp <- exp(t(prod_choice[,4]) %*% as.matrix(seg1_betas))
  seg1_prod4_exp <- exp(t(prod_choice[,5]) %*% as.matrix(seg1_betas))
  
  # Segment 1 market shares
  seg1_share_denom <- sum(seg1_prod1_exp, seg1_prod2_exp, seg1_prod3_exp, seg1_prod4_exp)
  seg1_prod1_share <- 100 * (seg1_prod1_exp / seg1_share_denom)
  seg1_prod2_share <- 100 * (seg1_prod2_exp / seg1_share_denom)
  seg1_prod3_share <- 100 * (seg1_prod3_exp / seg1_share_denom)
  seg1_prod4_share <- 100 * (seg1_prod4_exp / seg1_share_denom)
  
  # Segment 2 predicted betas
  seg2_betas <- as.matrix(gammas) %*% as.matrix(seg_choice[,3])
  
  # Segment 2 expected utilities
  seg2_prod1_exp <- exp(t(prod_choice[,2]) %*% as.matrix(seg2_betas))
  seg2_prod2_exp <- exp(t(prod_choice[,3]) %*% as.matrix(seg2_betas))
  seg2_prod3_exp <- exp(t(prod_choice[,4]) %*% as.matrix(seg2_betas))
  seg2_prod4_exp <- exp(t(prod_choice[,5]) %*% as.matrix(seg2_betas))
  
  # Segment 2 market shares
  seg2_share_denom <- sum(seg2_prod1_exp, seg2_prod2_exp, seg2_prod3_exp, seg2_prod4_exp)
  seg2_prod1_share <- 100 * (seg2_prod1_exp / seg2_share_denom)
  seg2_prod2_share <- 100 * (seg2_prod2_exp / seg2_share_denom)
  seg2_prod3_share <- 100 * (seg2_prod3_exp / seg2_share_denom)
  seg2_prod4_share <- 100 * (seg2_prod4_exp / seg2_share_denom)
  
  # Segment 3 predicted betas
  seg3_betas <- as.matrix(gammas) %*% as.matrix(seg_choice[,4])
  
  # Segment 3 expected utilities
  seg3_prod1_exp <- exp(t(prod_choice[,2]) %*% as.matrix(seg3_betas))
  seg3_prod2_exp <- exp(t(prod_choice[,3]) %*% as.matrix(seg3_betas))
  seg3_prod3_exp <- exp(t(prod_choice[,4]) %*% as.matrix(seg3_betas))
  seg3_prod4_exp <- exp(t(prod_choice[,5]) %*% as.matrix(seg3_betas))
  
  # Segment 3 market shares
  seg3_share_denom <- sum(seg3_prod1_exp, seg3_prod2_exp, seg3_prod3_exp, seg3_prod4_exp)
  seg3_prod1_share <- 100 * (seg3_prod1_exp / seg3_share_denom)
  seg3_prod2_share <- 100 * (seg3_prod2_exp / seg3_share_denom)
  seg3_prod3_share <- 100 * (seg3_prod3_exp / seg3_share_denom)
  seg3_prod4_share <- 100 * (seg3_prod4_exp / seg3_share_denom)
  
  # Data for plotly
  plot_data <- data.frame(
    Value = c(
      # Segment 1
      seg1_prod1_share, seg1_prod2_share, seg1_prod3_share, seg1_prod4_share, 
      # Segment 2
      seg2_prod1_share, seg2_prod2_share, seg2_prod3_share, seg2_prod4_share,
      # Segment 3
      seg3_prod1_share, seg3_prod2_share, seg3_prod3_share, seg3_prod4_share
    ),
    Product = c(input$prod1_name, input$prod2_name, input$prod3_name, input$prod4_name),
    Segment = c(
      rep(input$seg1_name, 4), 
      rep(input$seg2_name, 4), 
      rep(input$seg3_name, 4)
    )
  )
  
  ggplotly(
    plot_data %>% 
      # Factor Product and Segment with ordered=TRUE
      mutate(
        Product = factor(
          Product, 
          levels = c(input$prod1_name, input$prod2_name, input$prod3_name, input$prod4_name), 
          ordered = TRUE
        ),
        Segment = factor(
          Segment, 
          levels = c(input$seg1_name, input$seg2_name, input$seg3_name), 
          ordered = TRUE
        )
      ) %>% 
      ggplot(aes(y = Value, x = Product, fill = Segment)) +
      geom_bar(position = "dodge", stat = "identity") +
      labs(x="", y = "Market Share") + 
      scale_fill_manual(values = c("#FFC30B", "#28a153", "#c23838")) +
      theme(
        legend.position = "right",
        panel.background = element_blank(),
        panel.grid.major.y = element_line(color = "#D3D3D3")
      )
    )
})

# Compute and render the market share as a table
# renderTable({
#   prod_choice = prod_reactive()
#   seg_choice = seg_reactive()
#     
#   # Segment 1 predicted betas
#   seg1_betas <- as.matrix(gammas) %*% as.matrix(seg_choice[,2])
#   
#   # Segment 1 expected utilities
#   seg1_prod1_exp <- exp(t(prod_choice[,2]) %*% as.matrix(seg1_betas))
#   seg1_prod2_exp <- exp(t(prod_choice[,3]) %*% as.matrix(seg1_betas))
#   seg1_prod3_exp <- exp(t(prod_choice[,4]) %*% as.matrix(seg1_betas))
#   seg1_prod4_exp <- exp(t(prod_choice[,5]) %*% as.matrix(seg1_betas))
#   
#   # Segment 1 market shares
#   seg1_share_denom <- sum(seg1_prod1_exp, seg1_prod2_exp, seg1_prod3_exp, seg1_prod4_exp)
#   seg1_prod1_share <- 100 * (seg1_prod1_exp / seg1_share_denom)
#   seg1_prod2_share <- 100 * (seg1_prod2_exp / seg1_share_denom)
#   seg1_prod3_share <- 100 * (seg1_prod3_exp / seg1_share_denom)
#   seg1_prod4_share <- 100 * (seg1_prod4_exp / seg1_share_denom)
#   
#   # Segment 2 predicted betas
#   seg2_betas <- as.matrix(gammas) %*% as.matrix(seg_choice[,3])
#   
#   # Segment 2 expected utilities
#   seg2_prod1_exp <- exp(t(prod_choice[,2]) %*% as.matrix(seg2_betas))
#   seg2_prod2_exp <- exp(t(prod_choice[,3]) %*% as.matrix(seg2_betas))
#   seg2_prod3_exp <- exp(t(prod_choice[,4]) %*% as.matrix(seg2_betas))
#   seg2_prod4_exp <- exp(t(prod_choice[,5]) %*% as.matrix(seg2_betas))
#   
#   # Segment 2 market shares
#   seg2_share_denom <- sum(seg2_prod1_exp, seg2_prod2_exp, seg2_prod3_exp, seg2_prod4_exp)
#   seg2_prod1_share <- 100 * (seg2_prod1_exp / seg2_share_denom)
#   seg2_prod2_share <- 100 * (seg2_prod2_exp / seg2_share_denom)
#   seg2_prod3_share <- 100 * (seg2_prod3_exp / seg2_share_denom)
#   seg2_prod4_share <- 100 * (seg2_prod4_exp / seg2_share_denom)
#   
#   # Segment 3 predicted betas
#   seg3_betas <- as.matrix(gammas) %*% as.matrix(seg_choice[,4])
#   
#   # Segment 3 expected utilities
#   seg3_prod1_exp <- exp(t(prod_choice[,2]) %*% as.matrix(seg3_betas))
#   seg3_prod2_exp <- exp(t(prod_choice[,3]) %*% as.matrix(seg3_betas))
#   seg3_prod3_exp <- exp(t(prod_choice[,4]) %*% as.matrix(seg3_betas))
#   seg3_prod4_exp <- exp(t(prod_choice[,5]) %*% as.matrix(seg3_betas))
#   
#   # Segment 3 market shares
#   seg3_share_denom <- sum(seg3_prod1_exp, seg3_prod2_exp, seg3_prod3_exp, seg3_prod4_exp)
#   seg3_prod1_share <- 100 * (seg3_prod1_exp / seg3_share_denom)
#   seg3_prod2_share <- 100 * (seg3_prod2_exp / seg3_share_denom)
#   seg3_prod3_share <- 100 * (seg3_prod3_exp / seg3_share_denom)
#   seg3_prod4_share <- 100 * (seg3_prod4_exp / seg3_share_denom)
#   
#   # Table
#   data <- data.frame(
#     Shares = c(
#       # Segment 1
#       seg1_prod1_share, seg1_prod2_share, seg1_prod3_share, seg1_prod4_share, 
#       # Segment 2
#       seg2_prod1_share, seg2_prod2_share, seg2_prod3_share, seg2_prod4_share,
#       # Segment 3
#       seg3_prod1_share, seg3_prod2_share, seg3_prod3_share, seg3_prod4_share
#     ),
#     Product = c(input$prod1_name, input$prod2_name, input$prod3_name, input$prod4_name),
#     Segment = c(
#       rep(input$seg1_name, 4), 
#       rep(input$seg2_name, 4), 
#       rep(input$seg3_name, 4)
#     )
#   ) %>% 
#     pivot_wider(names_from = Segment, values_from = Shares)
#   
#   data
# })
```

Product Configurations {.sidebar}
-------------------------------------------------

### Product 1

```{r prod1-inputs}
# Naming
textInput(
  "prod1_name",
  label = "Product Name:",
  value = "Product 1",
  placeholder = "Enter Product Name",
  width = "450px"
)

# Brand
renderUI({
  prod_data = product_data()
  selectInput(
    "prod1_prod",
    label = "Brand:",
    choice = c("Hydroflask", "Conmigo", "Nalgene", "Camelbak"),
    # selected = "Hydroflask",
    selected = as.character(prod_data[1:4,][which(prod_data[1:4,2] == 1), 1]),
    width = "450px"
  )
})

# Lid Type
renderUI({
  prod_data = product_data()
  selectInput(
    "prod1_lid", 
    label = "Lid Type:",
    choices = c("Screwlid", "Wide Mouth", "Squeeze", "Straw"),
    # selected = "Screwlid",
    selected = ifelse(
      sum(prod_data[5:7,2]) == 0, "Screwlid",
      as.character(prod_data[5:7,][which(prod_data[5:7,2] == 1), 1])
    ),
    width = "450px"
  )
})

# Size
renderUI({
  prod_data = product_data()
  selectInput(
    "prod1_size",
    label = "Size:",
    choices = c(
      "24 oz",
      "36 oz"
    ),
    # selected = "24 oz",
    selected = ifelse(
      sum(prod_data[8,2]) == 0, "24 oz",
      as.character(prod_data[8,][which(prod_data[8,2] == 1), 1])
    ),
    width = "450px"
  )
})

# Material
renderUI({
  prod_data = product_data()
  selectInput(
    "prod1_mat",
    label = "Material:",
    choices = c(
      "Plastic",
      "Metal"
    ),
    # selected = "Plastic",
    selected = ifelse(
      sum(prod_data[9,2]) == 0, "Plastic",
      as.character(prod_data[9,][which(prod_data[9,2] == 1), 1])
    ),
    width = "450px"
  )
})

# Color
renderUI({
  prod_data = product_data()
  selectInput(
    "prod1_color",
    label = "Color:",
    choices = c(
      "Clear",
      "Red",
      "Blue"
    ),
    # selected = "Clear",
    selected = ifelse(
      sum(prod_data[10:11,2]) == 0, "Clear",
      as.character(prod_data[10:11,][which(prod_data[10:11,2] == 1), 1])
    ),
    width = "450px"
  )
})

# Price
renderUI({
  prod_data = product_data()
  selectInput(
    "prod1_price",
    label = "Price:",
    choices = c(
      "$19.99",
      "$24.99",
      "$29.99"
    ),
    # selected = "$19.99",
    selected = ifelse(
      sum(prod_data[12:13,2]) == 0, "$19.99",
      as.character(prod_data[12:13,][which(prod_data[12:13,2] == 1), 1])
    ),
    width = "450px"
  )
})
```

### Product 2

```{r prod2-inputs}
# Naming
textInput(
  "prod2_name",
  label = "Product Name:",
  value = "Product 2",
  placeholder = "Enter Product Name",
  width = "450px"
)

# Brand
renderUI({
  prod_data = product_data()
  selectInput(
    "prod2_prod",
    label = "Product:",
    choice = c("Hydroflask", "Conmigo", "Nalgene", "Camelbak"),
    # selected = "Red Cross",
    selected = as.character(prod_data[1:4,][which(prod_data[1:4,3] == 1), 1]),
    width = "450px"
  )
})

# Lid Type
renderUI({
  prod_data = product_data()
  selectInput(
    "prod2_lid", 
    label = "Product Name:",
    choices = c("Screwlid", "Wide Mouth", "Squeeze", "Straw"),
    # selected = "Screwlid",
    selected = ifelse(
      sum(prod_data[5:7,3]) == 0, "Screwlid",
      as.character(prod_data[5:7,][which(prod_data[5:7,3] == 1), 1])
    ),
    width = "450px"
  )
})

# Size
renderUI({
  prod_data = product_data()
  selectInput(
    "prod2_size",
    label = "Size:",
    choices = c(
      "24 oz",
      "36 oz"
    ),
    # selected = "24 oz",
    selected = ifelse(
      sum(prod_data[8,3]) == 0, "24 oz",
      as.character(prod_data[8,][which(prod_data[8,3] == 1), 1])
    ),
    width = "450px"
  )
})

# Material
renderUI({
  prod_data = product_data()
  selectInput(
    "prod2_mat",
    label = "Material:",
    choices = c(
      "Plastic",
      "Metal"
    ),
    # selected = "Plastic",
    selected = ifelse(
      sum(prod_data[9,3]) == 0, "Plastic",
      as.character(prod_data[9,][which(prod_data[9,3] == 1), 1])
    ),
    width = "450px"
  )
})

# Color
renderUI({
  prod_data = product_data()
  selectInput(
    "prod2_color",
    label = "Color:",
    choices = c(
      "Clear",
      "Red",
      "Blue"
    ),
    # selected = "Clear",
    selected = ifelse(
      sum(prod_data[10:11,3]) == 0, "Clear",
      as.character(prod_data[10:11,][which(prod_data[10:11,3] == 1), 1])
    ),
    width = "450px"
  )
})

# Price
renderUI({
  prod_data = product_data()
  selectInput(
    "prod2_price",
    label = "Price:",
    choices = c(
      "$19.99",
      "$24.99",
      "$29.99"
    ),
    # selected = "$19.99",
    selected = ifelse(
      sum(prod_data[12:13,3]) == 0, "$19.99",
      as.character(prod_data[12:13,][which(prod_data[12:13,3] == 1), 1])
    ),
    width = "450px"
  )
})
```

### Product 3

```{r prod3-inputs}
# Naming
textInput(
  "prod3_name",
  label = "Product Name:",
  value = "Product 3",
  placeholder = "Enter Product Name",
  width = "450px"
)

# Product
renderUI({
  prod_data = product_data()
  selectInput(
    "prod3_prod",
    label = "Product:",
    choice = c("Hydroflask", "Conmigo", "Nalgene", "Camelbak"),
    # selected = "Hydroflask",
    selected = as.character(prod_data[1:4,][which(prod_data[1:4,4] == 1), 1]),
    width = "450px"
  )
})

# Lid Type
renderUI({
  prod_data = product_data()
  selectInput(
    "prod3_lid", 
    label = "Lid Type:",
    choices = c("Screwlid", "Wide Mouth", "Squeeze", "Straw"),
    # selected = "Screwlid",
    selected = ifelse(
      sum(prod_data[5:7,4]) == 0, "Screwlid",
      as.character(prod_data[5:7,][which(prod_data[5:7,4] == 1), 1])
    ),
    width = "450px"
  )
})

# Size
renderUI({
  prod_data = product_data()
  selectInput(
    "prod3_size",
    label = "Size:",
    choices = c(
      "24 oz",
      "36 oz"
    ),
    # selected = "24 oz",
    selected = ifelse(
      sum(prod_data[8,4]) == 0, "24 oz",
      as.character(prod_data[8,][which(prod_data[8,4] == 1), 1])
    ),
    width = "450px"
  )
})

# Material
renderUI({
  prod_data = product_data()
  selectInput(
    "prod3_mat",
    label = "Material:",
    choices = c(
      "Plastic", 
      "Metal"
    ),
    # selected = "Plastic",
    selected = ifelse(
      sum(prod_data[9,4]) == 0, "Plastic",
      as.character(prod_data[9,][which(prod_data[9,4] == 1), 1])
    ),
    width = "450px"
  )
})

# Color
renderUI({
  prod_data = product_data()
  selectInput(
    "prod3_color",
    label = "Color:",
    choices = c(
      "Clear", 
      "Red", 
      "Blue"
    ),
    # selected = "Clear",
    selected = ifelse(
      sum(prod_data[10:11,4]) == 0, "Clear",
      as.character(prod_data[10:11,][which(prod_data[10:11,4] == 1), 1])
    ),
    width = "450px"
  )
})

# Price
renderUI({
  prod_data = product_data()
  selectInput(
    "prod3_price",
    label = "Price",
    choices = c(
      "$19.99", 
      "$24.99",  
      "$29.99"
    ),
    # selected = "$19.99",
    selected = ifelse(
      sum(prod_data[12:13,4]) == 0, "$19.99",
      as.character(prod_data[12:13,][which(prod_data[12:13,4] == 1), 1])
    ),
    width = "450px"
  )
})
```

### Product 4

```{r prod4-inputs}
# Naming
textInput(
  "prod4_name",
  label = "Product Name:",
  value = "Product 4",
  placeholder = "Enter Product Name",
  width = "450px"
)

# Product
renderUI({
  prod_data = product_data()
  selectInput(
    "prod4_prod",
    label = "Product:",
    choice = c("Hydroflask", "Conmigo", "Nalgene", "Camelbak"),
    # selected = "Red Cross",
    selected = as.character(prod_data[1:4,][which(prod_data[1:4,5] == 1), 1]),
    width = "450px"
  )
})

# Lid Type
renderUI({
  prod_data = product_data()
  selectInput(
    "prod4_lid", 
    label = "Lid Type:",
    choices = c("Screwlid", "Wide Mouth", "Squeeze", "Straw"),
    # selected = "Screwlid",
    selected = ifelse(
      sum(prod_data[5:7,5]) == 0, "Screwlid",
      as.character(prod_data[5:7,][which(prod_data[5:7,5] == 1), 1])
    ),
    width = "450px"
  )
})

# Size
renderUI({
  prod_data = product_data()
  selectInput(
    "prod4_size",
    label = "Size",
    choices = c(
      "24 oz", 
      "36 oz"
    ),
    # selected = "24 oz",
    selected = ifelse(
      sum(prod_data[8,5]) == 0, "24 oz",
      as.character(prod_data[8,][which(prod_data[8,5] == 1), 1])
    ),
    width = "450px"
  )
})

# Material
renderUI({
  prod_data = product_data()
  selectInput(
    "prod4_mat",
    label = "Material:",
    choices = c(
      "Plastic", 
      "Metal"
    ),
    # selected = "Plastic",
    selected = ifelse(
      sum(prod_data[9,5]) == 0, "Plastic",
      as.character(prod_data[9,][which(prod_data[9,5] == 1), 1])
    ),
    width = "450px"
  )
})

# Color
renderUI({
  prod_data = product_data()
  selectInput(
    "prod4_color",
    label = "Color:",
    choices = c(
      "Clear", 
      "Red", 
      "Blue"
    ),
    # selected = "Clear",
    selected = ifelse(
      sum(prod_data[10:11,5]) == 0, "Clear",
      as.character(prod_data[10:11,][which(prod_data[10:11,5] == 1), 1])
    ),
    width = "450px"
  )
})

# Price
renderUI({
  prod_data = product_data()
  selectInput(
    "prod4_price",
    label = "Price",
    choices = c(
      "$19.99", 
      "$24.99",  
      "$29.99"
    ),
    # selected = "$19.99",
    selected = ifelse(
      sum(prod_data[12:13,5]) == 0, "$19.99",
      as.character(prod_data[12:13,][which(prod_data[12:13,5] == 1), 1])
    ),
    width = "450px"
  )
})
```

Segment 1 Configurations
-------------------------------------------------

### Segment 1

```{r seg1-inputs}
# Naming
textInput(
  "seg1_name",
  label = "Segment Name:",
  value = "Segment 1",
  placeholder = "Enter Segment Name",
  width = "450px"
)
# Gender
renderUI({
  seg_data = segment_data()
  selectInput(
    "seg1_gender",
    label = "Gender:",
    choices = c("Male", "Female", "Other"),
    # selected = "Male",
    selected = ifelse(
      sum(seg_data[2:3,2]) == 0, "Male",
      as.character(seg_data[2:3,][which(seg_data[2:3,2] == 1), 1])
    ),
    width = "450px"
  )
})

# Age
renderUI({
  seg_data = segment_data()
  selectInput(
    "seg1_age",
    label = "Age Bucket:",
    choices = c("<35", "35-50", "50+"),
    # selected = "<35",
    selected = ifelse(
      sum(seg_data[4:5,2]) == 0, "<35",
      as.character(seg_data[4:5,][which(seg_data[4:5,2] == 1), 1])
    ),
    width = "450px"
  )
})

# Race
renderUI({
  seg_data = segment_data()
  selectInput(
    "seg1_news_medium",
    label = "Race:",
    choices = c(
      'White',
      'Black or African American',
      'American Indian or Alaskan Native',
      'Asian',
      'Native Hawaiian or Pacific Islander',
      'Hispanic or Latino',
      'Other race'
    ),
    multiple = TRUE,
    # selected = "White",
    selected = deframe(seg_data[6:12,][which(seg_data[6:12,2] == 1), 1]),
    width = "450px"
  )
})
 
```

Segment 2 Configurations
-------------------------------------------------

### Segment 2

```{r seg2-inputs}
# Naming
textInput(
  "seg2_name",
  label = "Segment Name:",
  value = "Segment 2",
  placeholder = "Enter Segment Name",
  width = "450px"
)

# Gender
renderUI({
  seg_data = segment_data()
  selectInput(
    "seg2_gender",
    label = "Gender:",
    choices = c("Male", "Female", "Other"),
    # selected = "Male",
    selected = ifelse(
      sum(seg_data[2:3,3]) == 0, "Male",
      as.character(seg_data[2:3,][which(seg_data[2:3,3] == 1), 1])
    ),
    width = "450px"
  )
})

# Age
renderUI({
  seg_data = segment_data()
  selectInput(
    "seg2_age",
    label = "Age Bucket:",
    choices = c("<35", "35-50", "50+"),
    # selected = "<35",
    selected = ifelse(
      sum(seg_data[4:5,3]) == 0, "<35",
      as.character(seg_data[4:5,][which(seg_data[4:5,3] == 1), 1])
    ),
    width = "450px"
  )
})

# Race
renderUI({
  seg_data = segment_data()
  selectInput(
    "seg2_race",
    label = "Race:",
    choices = c(
      'White',
      'Black or African American',
      'American Indian or Alaskan Native',
      'Asian',
      'Native Hawaiian or Pacific Islander',
      'Hispanic or Latino',
      'Other race'
    ),
    multiple = TRUE,
    # selected = c("TV", "Print", "Social media"),
    selected = deframe(seg_data[6:12,][which(seg_data[6:12,3] == 1), 1]),
    width = "450px"
  )
})

```

### Segment 3

```{r seg3-inputs}
# Naming
textInput(
  "seg3_name",
  label = "Segment Name:",
  value = "Segment 3",
  placeholder = "Enter Segment Name",
  width = "450px"
)

# Gender
renderUI({
  seg_data = segment_data()
  selectInput(
    "seg3_gender",
    label = "Gender:",
    choices = c("Male", "Female", "Other"),
    # selected = "At least once a day",
    selected = ifelse(
      sum(seg_data[2:3,4]) == 0, "Male",
      as.character(seg_data[2:3,][which(seg_data[2:3,4] == 1), 1])
    ),
    width = "450px"
  )
})

# Age
renderUI({
  seg_data = segment_data()
  selectInput(
    "seg3_age",
    label = "Age Bucket:",
    choices = c("<35", "35-50", "50+"),
    # selected = "Always",
    selected = ifelse(
      sum(seg_data[4:5,4]) == 0, "<35",
      as.character(seg_data[4:5,][which(seg_data[4:5,4] == 1), 1])
    ),
    width = "450px"
  )
})

# Race
renderUI({
  seg_data = segment_data()
  selectInput(
    "seg3_race",
    label = "Race:",
    choices = c(
      'White',
      'Black or African American',
      'American Indian or Alaskan Native',
      'Asian',
      'Native Hawaiian or Pacific Islander',
      'Hispanic or Latino',
      'Other race'
    ),
    multiple = TRUE,
    # selected = c("TV", "Print", "Social media"),
    selected = deframe(seg_data[6:12,][which(seg_data[6:12,4] == 1), 1]),
    width = "450px"
  )
})

```

Import & Export
====================================================

### File Import

```{r import}
# Organization configuration import
fileInput(
 "prod_update",
 "Import Product Data",
 accept = c(
   "text/csv",
   "text/comma-separated-values,text/plain",
   ".csv"
 )
)
actionButton(
 "prod_button",
 label = "Update Product Data"
)

# segment configuration import
fileInput(
  "seg_update",
  "Import segment Data",
  accept = c(
    "text/csv",
    "text/comma-separated-values,text/plain",
    ".csv"
  )
)
actionButton(
  "seg_button",
  label = "Update segment Data"
)


# Use the default configurations if no inputs are provided
product_data <- reactive({
  if (is.null(input$prod_update$datapath)) {
    x <- prod_default
  } else {
    req(input$prod_button)
    req(input$prod_update)
    x <- read_csv(input$prod_update$datapath)
  }
})

segment_data <- reactive({
  if (is.null(input$seg_update$datapath)) {
    x <- seg_default
  } else {
    req(input$seg_button)
    req(input$seg_update)
    x <- read_csv(input$seg_update$datapath)
  }
})
```

Row
------------------------------------------------------

### File Export

```{r export}
# Render the organization configuration as a table
renderTable({
  prod_choice = prod_reactive()
  prod_choice
})

# Download organization configuration
downloadButton("download_prod", label = "Download Product Data")

downloadHandler(
  filename = function() {
    paste0("prod_data_",Sys.time(),".csv")
  },
  content = function(file) {
    write_csv(prod_reactive(), file)
  }
)

# Render the segment configuration as a table
renderTable({
  seg_choice = seg_reactive()
  seg_choice
})

# Download segment configuration
downloadButton("download_seg", label = "Download segment Data")

downloadHandler(
  filename = function() {
    paste0("seg_data_",Sys.time(),".csv")
  },
  content = function(file) {
    write_csv(seg_reactive(), file)
  }
)
```
